<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Météo Vélo - Mobile Friendly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f9fbff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
    }

    .event-card {
      width: 100%;
      max-width: 480px;
      margin: 1rem auto;
      padding: 1rem;
      border-radius: 12px;
      background: linear-gradient(135deg, #f0f4ff, #e0eaff);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      color: #333;
    }

    .event-card h2 {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      color: #2a4d9b;
    }

    .event-card p {
      margin: 0.5rem 0;
      font-size: 1rem;
    }

    #weather-decision {
      font-weight: bold;
      font-size: 1.1rem;
    }

    canvas {
      width: 100% !important;
      max-width: 100%;
    }
  </style>
</head>
<body>

  <section class="event-card">
    <h2>🌦 Météo pour le prochain événement</h2>
    <div id="event-weather">
      <p><strong>📅 Événement :</strong> <span id="weather-event-title">Chargement...</span></p>
      <p><strong>🕒 Date :</strong> <span id="weather-event-date">–</span></p>
      <p><strong>📍 Lieu :</strong> <span id="weather-event-location">–</span></p>
      <p><strong>🌡 Température :</strong> <span id="weather-temp">–</span>°C</p>
      <p><strong>🌬 Vent :</strong> <span id="weather-wind">–</span></p>
      <p><strong>☁️ Ciel :</strong> <span id="weather-condition">–</span></p>
      <p><strong>🌤 Icône :</strong> <img id="weather-icon" src="" alt="Icône météo" style="height: 50px;"></p>
      <p><strong>🚴 Sortie :</strong> <span id="weather-decision">Analyse...</span></p>
    </div>
  </section>

  <section class="event-card">
    <h2>📊 Température sur 24h</h2>
    <canvas id="tempChart"></canvas>
  </section>

  <script>
    const apiKey = '0f9f95c50d2d777d38a9314a4ffadc93';
    const cityCoords = { lat: 48.8383, lon: 2.7908 };

    fetch('https://github.com/ddefin/calendrier-cyclo/edit/main/calendrier.ics')
      .then(res => res.text())
      .then(text => {
        const events = text.split('BEGIN:VEVENT');
        let nextEvent = null;

        for (const evt of events) {
          const dtMatch = evt.match(/DTSTART(?:;TZID=Europe\/Paris)?:([0-9T]+)/);
          if (dtMatch) {
            const dt = dtMatch[1];
            const date = new Date(
              dt.slice(0, 4),
              dt.slice(4, 6) - 1,
              dt.slice(6, 8),
              dt.includes('T') ? dt.slice(9, 11) : 0,
              dt.includes('T') ? dt.slice(11, 13) : 0
            );
            if (date > new Date()) {
              nextEvent = { raw: evt, date };
              break;
            }
          }
        }

        if (!nextEvent) {
          document.getElementById('weather-event-title').textContent = "Aucun événement trouvé";
          return;
        }

        const title = nextEvent.raw.match(/SUMMARY:(.+)/)?.[1] || "Événement";
        const location = nextEvent.raw.match(/LOCATION:(.+)/)?.[1] || "Lieu non précisé";
        const eventDate = nextEvent.date;

        document.getElementById('weather-event-title').textContent = title;
        document.getElementById('weather-event-date').textContent = eventDate.toLocaleString('fr-FR');
        document.getElementById('weather-event-location').textContent = location;

        const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${cityCoords.lat}&lon=${cityCoords.lon}&units=metric&lang=fr&appid=${apiKey}`;

        return fetch(apiUrl).then(res => res.json()).then(data => {
          let closest = null;
          let minDiff = Infinity;
          const labels = [], temps = [];

          for (const item of data.list) {
            const forecastDate = new Date(item.dt * 1000);
            const diff = Math.abs(eventDate - forecastDate);
            if (diff < minDiff) {
              minDiff = diff;
              closest = item;
            }
            labels.push(forecastDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            temps.push(item.main.temp);
          }

          if (closest) {
            const temp = Math.round(closest.main.temp);
            const wind = Math.round(closest.wind.speed * 3.6);
            const gust = Math.round((closest.wind.gust || closest.wind.speed) * 3.6);
            const dir = degToCardinal(closest.wind.deg);
            const condition = closest.weather[0].description;
            const iconCode = closest.weather[0].icon;
            const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;

            const decision = analyzeRideCondition(temp, wind, gust, condition);

            document.getElementById('weather-temp').textContent = temp;
            document.getElementById('weather-wind').textContent = `${wind} km/h ${dir} (rafales ${gust} km/h)`;
            document.getElementById('weather-condition').textContent = condition;
            document.getElementById('weather-icon').src = iconUrl;
            document.getElementById('weather-decision').textContent = decision.message;
            document.getElementById('weather-decision').style.color = decision.color;
          }

          new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: {
              labels: labels.slice(0, 8),
              datasets: [{
                label: 'Température (°C)',
                data: temps.slice(0, 8),
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        });
      });

    function degToCardinal(deg) {
      const dirs = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"];
      return dirs[Math.round(deg / 45) % 8];
    }

    function analyzeRideCondition(temp, wind, gust, condition) {
      let note = 0;
      if (temp >= 10 && temp <= 28) note += 2;
      if (wind <= 20) note += 2;
      if (gust <= 30) note += 1;
      if (!condition.includes("pluie") && !condition.includes("orage")) note += 2;

      if (note >= 6) return { message: "Favorable ✅", color: "green" };
      if (note >= 4) return { message: "Acceptable ⚠️", color: "orange" };
      return { message: "Déconseillé ❌", color: "red" };
    }
  </script>

</body>
</html>
