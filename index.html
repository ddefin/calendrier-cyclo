<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calendrier Cyclo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header, section { padding: 20px; }
    header { background: #2c3e50; color: white; }
    h1 { margin: 0; }
    .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    #map { height: 400px; }
    .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<header>
  <h1>🚴‍♂️ Calendrier Cyclo</h1>
</header>

<section class="container">
  <div class="card">
    <h2>📅 Prochain événement</h2>
    <div id="next-event">Chargement...</div>
  </div>

  <div class="card">
    <h2>🌬️ Météo</h2>
    <div id="weather">Chargement...</div>
  </div>
</section>

<section class="container">
  <div class="card">
    <h2>🗺️ Parcours Groupe 1</h2>
    <div id="map"></div>
  </div>

  <div class="card">
    <h2>🌞 Éphéméride</h2>
    <div id="ephemeris">Chargement...</div>
  </div>
</section>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-gpx"></script>
<script>
  // 📍 Affichage du parcours GPX
  const map = L.map('map').setView([48.85, 2.77], 12); // Centré sur Noisiel
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  new L.GPX('groupe1.gpx', { async: true }).on('loaded', e => {
    map.fitBounds(e.target.getBounds());
  }).addTo(map);

  // 📅 Lecture du fichier ICS
  fetch('calendrier.ics')
    .then(res => res.text())
    .then(text => {
      const match = text.match(/DTSTART:(\d{8}T\d{6})/);
      if (match) {
        const dt = match[1];
        const date = new Date(
          dt.slice(0,4),
          dt.slice(4,6)-1,
          dt.slice(6,8),
          dt.slice(9,11),
          dt.slice(11,13)
        );
        document.getElementById('next-event').textContent = date.toLocaleString('fr-FR');
      } else {
        document.getElementById('next-event').textContent = "Aucun événement trouvé.";
      }
    });

  // 🌬️ Météo via OpenWeatherMap
  const apiKey = '0f9f95c50d2d777d38a9314a4ffadc93';
  fetch(`https://api.openweathermap.org/data/2.5/weather?lat=48.85&lon=2.77&units=metric&appid=${apiKey}`)
    .then(res => res.json())
    .then(data => {
      const wind = data.wind;
      const deg = wind.deg;
      const dir = ['N','NE','E','SE','S','SW','W','NW'][Math.round(deg/45)%8];
      document.getElementById('weather').innerHTML = `
        Vent : ${wind.speed} km/h (${dir})<br>
        Rafales : ${wind.gust || 'N/A'} km/h
      `;
    });

  // 🌞 Éphéméride (lever/coucher du soleil)
  fetch('https://api.sunrise-sunset.org/json?lat=48.85&lng=2.77&formatted=0')
    .then(res => res.json())
    .then(data => {
      const sunrise = new Date(data.results.sunrise).toLocaleTimeString('fr-FR');
      const sunset = new Date(data.results.sunset).toLocaleTimeString('fr-FR');
      document.getElementById('ephemeris').innerHTML = `
        Lever du soleil : ${sunrise}<br>
        Coucher du soleil : ${sunset}
      `;
    });
</script>

</body>
</html>
