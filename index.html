<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>M√©t√©o V√©lo - Mobile Friendly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #2a4d9b;
      --background-gradient: linear-gradient(135deg, #f0f4ff, #e0eaff);
      --text-color: #333;
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f9fbff, #e8f2ff);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1rem;
      min-height: 100vh;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .event-card {
      width: 100%;
      margin: 1rem 0;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      background: var(--background-gradient);
      box-shadow: var(--shadow);
      color: var(--text-color);
      transition: transform 0.2s ease;
    }

    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .event-card h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.4rem;
      color: var(--primary-color);
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .info-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background: rgba(255,255,255,0.4);
      border-radius: 8px;
      font-size: 0.95rem;
    }

    .info-item strong {
      min-width: 80px;
      color: var(--primary-color);
    }

    .info-item .emoji {
      margin-right: 0.5rem;
      font-size: 1.1rem;
    }

    #weather-decision {
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.6);
      margin: 1rem 0;
    }

    .weather-icon {
      height: 60px;
      width: 60px;
      object-fit: contain;
    }

    .chart-container {
      position: relative;
      height: 250px;
      margin: 1.5rem 0;
      background: rgba(255,255,255,0.5);
      border-radius: 8px;
      padding: 1rem;
    }

    .cta-button {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(42, 77, 155, 0.3);
    }

    .cta-button:hover {
      background: #1e3a7a;
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(42, 77, 155, 0.4);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      font-style: italic;
      color: #666;
    }

    .error {
      background: #fee2e2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .alert-section {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 8px;
      font-weight: 500;
    }

    .alert-danger {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #dc2626;
      border-left: 4px solid #ef4444;
    }

    .alert-warning {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #d97706;
      border-left: 4px solid #f59e0b;
    }

    .alert-info {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #2563eb;
      border-left: 4px solid #3b82f6;
    }

    .comfort-index {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .comfort-item {
      text-align: center;
      padding: 0.75rem;
      background: rgba(255,255,255,0.6);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .comfort-score {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .precipitation-timeline {
      background: rgba(255,255,255,0.6);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .precipitation-timeline h4 {
      margin: 0 0 1rem 0;
      color: var(--primary-color);
      text-align: center;
    }

    .precip-bars {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .precip-bar {
      text-align: center;
      font-size: 0.8rem;
    }

    .precip-visual {
      height: 40px;
      background: linear-gradient(to top, #3b82f6, #60a5fa);
      border-radius: 4px 4px 0 0;
      margin-bottom: 0.25rem;
      position: relative;
    }

    .wind-analysis {
      background: rgba(255,255,255,0.6);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
    }

    .wind-direction-indicator {
      font-size: 2rem;
      margin: 0.5rem 0;
    }

    .evolution-section {
      background: rgba(255,255,255,0.6);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .evolution-timeline {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .evolution-point {
      text-align: center;
      padding: 0.5rem;
      background: rgba(255,255,255,0.8);
      border-radius: 6px;
      font-size: 0.85rem;
    }

        @media (max-width: 480px) {
      .event-card {
        padding: 1rem;
      }
      
      .info-item {
        font-size: 0.9rem;
      }
      
      .weather-icon {
        height: 50px;
        width: 50px;
      }

      .comfort-index {
        grid-template-columns: repeat(2, 1fr);
      }

      .evolution-timeline {
        grid-template-columns: repeat(3, 1fr);
      }

      .precip-bars {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <section class="event-card">
      <h2>üå¶ M√©t√©o pour le prochain √©v√©nement</h2>
      
      <div id="loading" class="loading">
        Chargement des donn√©es m√©t√©o...
      </div>
      
      <div id="event-weather" style="display: none;">
        <div class="info-grid">
          <div class="info-item">
            <span class="emoji">üìÖ</span>
            <strong>√âv√©nement :</strong>
            <a href="https://connect.garmin.com/modern/course/387468682" target="_blank" id="weather-event-title">‚Äì</a>
          </div>
          
          <div class="info-item">
            <span class="emoji">üïí</span>
            <strong>Date :</strong>
            <span id="weather-event-date">‚Äì</span>
          </div>
          
          <div class="info-item">
            <span class="emoji">üìç</span>
            <strong>Lieu :</strong>
            <span id="weather-event-location">‚Äì</span>
          </div>
          
          <div class="info-item">
            <span class="emoji">üå°</span>
            <strong>Temp√©rature :</strong>
            <span id="weather-temp">‚Äì</span>¬∞C
          </div>
          
          <div class="info-item">
            <span class="emoji">üå¨</span>
            <strong>Vent :</strong>
            <span id="weather-wind">‚Äì</span>
          </div>
          
          <div class="info-item">
            <span class="emoji">‚òÅÔ∏è</span>
            <strong>Ciel :</strong>
            <span id="weather-condition">‚Äì</span>
          </div>
          
          <div class="info-item">
            <span class="emoji">üå§</span>
            <strong>Ic√¥ne :</strong>
            <img id="weather-icon" class="weather-icon" src="" alt="Ic√¥ne m√©t√©o">
          </div>
        </div>
        
        <div id="weather-decision">Analyse...</div>
        
        <div id="alerts-section"></div>
        
        <div id="comfort-index" class="comfort-index"></div>
        
        <div id="precipitation-timeline" class="precipitation-timeline"></div>
        
        <div id="wind-analysis" class="wind-analysis"></div>
        
        <div id="evolution-section" class="evolution-section"></div>
        
        <div class="chart-container">
          <canvas id="tempChart"></canvas>
        </div>
        
        <div style="text-align: center; margin-top: 1.5rem;">
          <a href="https://connect.garmin.com/modern/course/387468682" target="_blank" class="cta-button">
            üîó Voir le parcours sur Garmin
          </a>
        </div>
      </div>
      
      <div id="error-message" class="error" style="display: none;"></div>
    </section>
  </div>

  <script>
    // Configuration centralis√©e
    const CONFIG = {
      apiKey: '0f9f95c50d2d777d38a9314a4ffadc93',
      cityCoords: { lat: 48.8383, lon: 2.7908 },
      calendarUrl: 'https://ddefin.github.io/calendrier-cyclo/calendrier.ics',
      weatherApiUrl: 'https://api.openweathermap.org/data/2.5/forecast',
      iconBaseUrl: 'https://openweathermap.org/img/wn/',
      // Direction g√©n√©rale du parcours Garmin (en degr√©s, 0 = Nord)
      courseDirection: 45 // NE - √† ajuster selon votre parcours principal
    };

    // Classe principale pour g√©rer l'application m√©t√©o
    class WeatherApp {
      constructor() {
        this.chart = null;
        this.init();
      }

      async init() {
        try {
          const nextEvent = await this.getNextEvent();
          if (!nextEvent) {
            this.showError('Aucun √©v√©nement trouv√© dans le calendrier');
            return;
          }

          this.displayEventInfo(nextEvent);
          const weatherData = await this.getWeatherData();
          this.displayWeatherInfo(nextEvent.date, weatherData);
          this.displayAlerts(nextEvent.date, weatherData);
          this.displayComfortIndex(nextEvent.date, weatherData);
          this.displayPrecipitationTimeline(nextEvent.date, weatherData);
          this.displayWindAnalysis(nextEvent.date, weatherData);
          this.displayEvolutionConditions(nextEvent.date, weatherData);
          this.createChart(weatherData);
          
          document.getElementById('loading').style.display = 'none';
          document.getElementById('event-weather').style.display = 'block';
        } catch (error) {
          this.showError(`Erreur lors du chargement: ${error.message}`);
        }
      }

      async getNextEvent() {
        const response = await fetch(CONFIG.calendarUrl);
        if (!response.ok) throw new Error('Impossible de charger le calendrier');
        
        const text = await response.text();
        const events = text.split('BEGIN:VEVENT');
        const now = new Date();

        for (const evt of events.slice(1)) { // Skip first empty element
          const event = this.parseEvent(evt);
          if (event && event.date > now) {
            return event;
          }
        }
        return null;
      }

      parseEvent(eventText) {
        const dtMatch = eventText.match(/DTSTART(?:;TZID=Europe\/Paris)?:([0-9T]+)/);
        if (!dtMatch) return null;

        const dt = dtMatch[1];
        const date = new Date(
          parseInt(dt.slice(0, 4)),
          parseInt(dt.slice(4, 6)) - 1,
          parseInt(dt.slice(6, 8)),
          dt.includes('T') ? parseInt(dt.slice(9, 11)) : 9, // Default to 9h if no time
          dt.includes('T') ? parseInt(dt.slice(11, 13)) : 0
        );

        // Parsing plus robuste du titre et du lieu
        const titleMatch = eventText.match(/SUMMARY:(.+?)(?:\r?\n|\r)/);
        const locationMatch = eventText.match(/LOCATION:(.+?)(?:\r?\n|\r)/);
        
        // Debug - affichons ce qu'on trouve
        console.log('Event text preview:', eventText.substring(0, 500));
        console.log('Title match:', titleMatch);
        console.log('Location match:', locationMatch);

        const title = titleMatch?.[1]?.trim() || "√âv√©nement cycliste";
        const location = locationMatch?.[1]?.trim() || "1 rue des labours 77700 Magny le Hongre";

        return {
          date,
          title,
          location
        };
      }

      async getWeatherData() {
        const url = `${CONFIG.weatherApiUrl}?lat=${CONFIG.cityCoords.lat}&lon=${CONFIG.cityCoords.lon}&units=metric&lang=fr&appid=${CONFIG.apiKey}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Impossible de charger les donn√©es m√©t√©o');
        return response.json();
      }

      displayEventInfo(event) {
        document.getElementById('weather-event-title').textContent = event.title;
        document.getElementById('weather-event-date').textContent = event.date.toLocaleString('fr-FR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      displayAlerts(eventDate, weatherData) {
        const alerts = [];
        const eventForecast = this.findClosestForecast(eventDate, weatherData.list);
        const surroundingForecasts = this.getSurroundingForecasts(eventDate, weatherData.list, 4);

        // Alerte d√©gradation des conditions
        if (surroundingForecasts.length >= 3) {
          const tempTrend = this.analyzeTrend(surroundingForecasts.map(f => f.main.temp));
          const windTrend = this.analyzeTrend(surroundingForecasts.map(f => f.wind.speed * 3.6));
          
          if (tempTrend.decreasing && tempTrend.change > 5) {
            alerts.push({
              type: 'warning',
              message: `‚ö†Ô∏è Temp√©rature en baisse de ${Math.round(tempTrend.change)}¬∞C pendant l'√©v√©nement`
            });
          }
          
          if (windTrend.increasing && windTrend.change > 10) {
            alerts.push({
              type: 'warning',
              message: `üí® Vent en augmentation (+${Math.round(windTrend.change)} km/h)`
            });
          }
        }

        // Alerte pr√©cipitations
        if (eventForecast && eventForecast.weather[0].main === 'Rain') {
          const rainIntensity = eventForecast.rain?.['3h'] || 0;
          if (rainIntensity > 2) {
            alerts.push({
              type: 'danger',
              message: `üåßÔ∏è Pluie forte pr√©vue (${rainIntensity.toFixed(1)}mm/3h)`
            });
          } else {
            alerts.push({
              type: 'warning',
              message: `üå¶Ô∏è Pluie pr√©vue pendant l'√©v√©nement`
            });
          }
        }

        // Alerte vent fort
        if (eventForecast) {
          const windSpeed = eventForecast.wind.speed * 3.6;
          const gustSpeed = (eventForecast.wind.gust || eventForecast.wind.speed) * 3.6;
          
          if (windSpeed > 40) {
            alerts.push({
              type: 'danger',
              message: `üå™Ô∏è Vent tr√®s fort: ${Math.round(windSpeed)} km/h`
            });
          } else if (gustSpeed > 50) {
            alerts.push({
              type: 'warning',
              message: `üí® Rafales importantes: jusqu'√† ${Math.round(gustSpeed)} km/h`
            });
          }
        }

        // Alerte temp√©rature extr√™me
        if (eventForecast) {
          const temp = eventForecast.main.temp;
          if (temp < 0) {
            alerts.push({
              type: 'danger',
              message: `üßä Risque de verglas: ${Math.round(temp)}¬∞C`
            });
          } else if (temp > 35) {
            alerts.push({
              type: 'danger',
              message: `üî• Chaleur excessive: ${Math.round(temp)}¬∞C - Risque de d√©shydratation`
            });
          }
        }

        this.renderAlerts(alerts);
      }

      renderAlerts(alerts) {
        const container = document.getElementById('alerts-section');
        if (alerts.length === 0) {
          container.innerHTML = '<div class="alert-section alert-info">‚úÖ Aucune alerte m√©t√©o pour cet √©v√©nement</div>';
          return;
        }

        container.innerHTML = alerts.map(alert => 
          `<div class="alert-section alert-${alert.type}">${alert.message}</div>`
        ).join('');
      }

      displayComfortIndex(eventDate, weatherData) {
        const forecast = this.findClosestForecast(eventDate, weatherData.list);
        if (!forecast) return;

        const temp = forecast.main.temp;
        const humidity = forecast.main.humidity;
        const windSpeed = forecast.wind.speed * 3.6;
        const condition = forecast.weather[0].main;

        // Calcul indice de confort cycliste (0-10)
        let comfort = 5; // Base neutre

        // Confort temp√©rature
        if (temp >= 15 && temp <= 22) comfort += 2;
        else if (temp >= 10 && temp <= 28) comfort += 1;
        else if (temp < 5 || temp > 32) comfort -= 2;
        else comfort -= 1;

        // Confort vent (vent l√©ger = meilleur)
        if (windSpeed <= 10) comfort += 1.5;
        else if (windSpeed <= 20) comfort += 0.5;
        else if (windSpeed > 35) comfort -= 2;
        else comfort -= 1;

        // Confort humidit√©
        if (humidity <= 60) comfort += 0.5;
        else if (humidity >= 85) comfort -= 1;

        // Confort conditions
        if (['Clear', 'Clouds'].includes(condition)) comfort += 1;
        else if (condition === 'Rain') comfort -= 2;
        else if (['Thunderstorm', 'Snow'].includes(condition)) comfort -= 3;

        comfort = Math.max(0, Math.min(10, comfort));

        const comfortData = [
          { label: 'Confort Global', value: comfort.toFixed(1), color: this.getComfortColor(comfort) },
          { label: 'Temp√©rature', value: `${Math.round(temp)}¬∞C`, color: this.getTempColor(temp) },
          { label: 'Vent', value: `${Math.round(windSpeed)} km/h`, color: this.getWindColor(windSpeed) },
          { label: 'Humidit√©', value: `${humidity}%`, color: this.getHumidityColor(humidity) }
        ];

        document.getElementById('comfort-index').innerHTML = comfortData.map(item => 
          `<div class="comfort-item">
            <div class="comfort-score" style="color: ${item.color}">${item.value}</div>
            <div>${item.label}</div>
          </div>`
        ).join('');
      }

      displayPrecipitationTimeline(eventDate, weatherData) {
        const eventTime = eventDate.getTime();
        const relevantForecasts = weatherData.list.filter(item => {
          const forecastTime = item.dt * 1000;
          return Math.abs(forecastTime - eventTime) <= 6 * 60 * 60 * 1000; // 6h avant/apr√®s
        }).slice(0, 6);

        const precipData = relevantForecasts.map(item => {
          const date = new Date(item.dt * 1000);
          const precip = (item.rain?.['3h'] || 0) + (item.snow?.['3h'] || 0);
          const probability = item.pop * 100; // Probability of precipitation
          
          return {
            time: date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            precip: precip,
            probability: Math.round(probability),
            isEventTime: Math.abs(date.getTime() - eventTime) < 90 * 60 * 1000 // 1h30 de marge
          };
        });

        const maxPrecip = Math.max(...precipData.map(d => d.precip), 1);

        document.getElementById('precipitation-timeline').innerHTML = `
          <h4>‚òî Probabilit√© de pr√©cipitations</h4>
          <div class="precip-bars">
            ${precipData.map(data => `
              <div class="precip-bar ${data.isEventTime ? 'event-time' : ''}">
                <div class="precip-visual" style="height: ${(data.probability / 100) * 40}px; background: ${data.isEventTime ? 'linear-gradient(to top, #ef4444, #f87171)' : 'linear-gradient(to top, #3b82f6, #60a5fa)'}">
                </div>
                <div>${data.time}</div>
                <div><strong>${data.probability}%</strong></div>
              </div>
            `).join('')}
          </div>
          <div style="text-align: center; font-size: 0.8rem; color: #666;">
            Rouge = Heure de l'√©v√©nement
          </div>
        `;
      }

      displayWindAnalysis(eventDate, weatherData) {
        const forecast = this.findClosestForecast(eventDate, weatherData.list);
        if (!forecast) return;

        const windDirection = forecast.wind.deg;
        const windSpeed = Math.round(forecast.wind.speed * 3.6);
        const courseDirection = CONFIG.courseDirection;
        
        const windRelativeToCourse = this.analyzeWindDirection(windDirection, courseDirection);
        
        document.getElementById('wind-analysis').innerHTML = `
          <h4>üß≠ Analyse du vent sur le parcours</h4>
          <div class="wind-direction-indicator">${windRelativeToCourse.icon}</div>
          <div><strong>${windSpeed} km/h ${this.degToCardinal(windDirection)}</strong></div>
          <div style="margin-top: 0.5rem; font-size: 0.9rem;">
            ${windRelativeToCourse.description}
          </div>
          <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.8); border-radius: 4px; font-size: 0.85rem;">
            <strong>Impact:</strong> ${windRelativeToCourse.impact}
          </div>
        `;
      }

      displayEvolutionConditions(eventDate, weatherData) {
        const eventTime = eventDate.getTime();
        const timePoints = [
          { offset: -2, label: '-2h' },
          { offset: -1, label: '-1h' },
          { offset: 0, label: '√âv√©nement' },
          { offset: 1, label: '+1h' },
          { offset: 2, label: '+2h' }
        ];

        const evolutionData = timePoints.map(point => {
          const targetTime = new Date(eventTime + point.offset * 60 * 60 * 1000);
          const forecast = this.findClosestForecast(targetTime, weatherData.list);
          
          if (!forecast) return null;
          
          return {
            label: point.label,
            temp: Math.round(forecast.main.temp),
            wind: Math.round(forecast.wind.speed * 3.6),
            condition: forecast.weather[0].icon,
            precipitation: Math.round((forecast.pop || 0) * 100),
            isEvent: point.offset === 0
          };
        }).filter(Boolean);

        document.getElementById('evolution-section').innerHTML = `
          <h4>‚è∞ √âvolution des conditions (2h avant/apr√®s)</h4>
          <div class="evolution-timeline">
            ${evolutionData.map(data => `
              <div class="evolution-point ${data.isEvent ? 'event-time' : ''}" style="${data.isEvent ? 'background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444;' : ''}">
                <div class="evolution-time">${data.label}</div>
                <img src="${CONFIG.iconBaseUrl}${data.condition}.png" style="height: 30px; width: 30px;">
                <div>${data.temp}¬∞C</div>
                <div>${data.wind} km/h</div>
                <div>${data.precipitation}% ‚òî</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      getSurroundingForecasts(targetDate, forecasts, count) {
        const targetTime = targetDate.getTime();
        return forecasts
          .map(f => ({ ...f, timeDiff: Math.abs(f.dt * 1000 - targetTime) }))
          .sort((a, b) => a.timeDiff - b.timeDiff)
          .slice(0, count);
      }

      analyzeTrend(values) {
        if (values.length < 2) return { increasing: false, decreasing: false, change: 0 };
        
        const first = values[0];
        const last = values[values.length - 1];
        const change = Math.abs(last - first);
        
        return {
          increasing: last > first,
          decreasing: last < first,
          change: change
        };
      }

      analyzeWindDirection(windDeg, courseDeg) {
        const diff = Math.abs(windDeg - courseDeg);
        const normalizedDiff = Math.min(diff, 360 - diff);
        
        if (normalizedDiff <= 45) {
          return {
            icon: '‚¨ÜÔ∏è',
            description: 'Vent de face - R√©sistance importante',
            impact: 'Effort suppl√©mentaire requis, vitesse r√©duite'
          };
        } else if (normalizedDiff >= 135) {
          return {
            icon: '‚¨áÔ∏è', 
            description: 'Vent de dos - Assistance favorable',
            impact: 'Pouss√©e du vent, vitesse facilit√©e'
          };
        } else {
          const side = ((windDeg - courseDeg + 360) % 360) < 180 ? 'droit' : 'gauche';
          return {
            icon: normalizedDiff < 90 ? '‚ÜóÔ∏è' : '‚û°Ô∏è',
            description: `Vent de c√¥t√© ${side}`,
            impact: 'Attention √† la stabilit√©, possibles rafales lat√©rales'
          };
        }
      }

      getComfortColor(comfort) {
        if (comfort >= 8) return '#22c55e';
        if (comfort >= 6) return '#84cc16';
        if (comfort >= 4) return '#f59e0b';
        return '#ef4444';
      }

      getTempColor(temp) {
        if (temp >= 15 && temp <= 25) return '#22c55e';
        if (temp >= 10 && temp <= 30) return '#84cc16';
        if (temp >= 5 && temp <= 35) return '#f59e0b';
        return '#ef4444';
      }

      getWindColor(wind) {
        if (wind <= 15) return '#22c55e';
        if (wind <= 25) return '#84cc16';
        if (wind <= 35) return '#f59e0b';
        return '#ef4444';
      }

      getHumidityColor(humidity) {
        if (humidity <= 60) return '#22c55e';
        if (humidity <= 75) return '#84cc16';
        if (humidity <= 85) return '#f59e0b';
        return '#ef4444';
        document.getElementById('weather-event-location').textContent = event.location;
      }

      displayWeatherInfo(eventDate, weatherData) {
        const forecast = this.findClosestForecast(eventDate, weatherData.list);
        if (!forecast) {
          this.showError('Pr√©visions m√©t√©o non disponibles pour cette date');
          return;
        }

        const temp = Math.round(forecast.main.temp);
        const wind = Math.round(forecast.wind.speed * 3.6);
        const gust = Math.round((forecast.wind.gust || forecast.wind.speed) * 3.6);
        const direction = this.degToCardinal(forecast.wind.deg);
        const condition = forecast.weather[0].description;
        const iconCode = forecast.weather[0].icon;

        document.getElementById('weather-temp').textContent = temp;
        document.getElementById('weather-wind').textContent = `${wind} km/h ${direction} (rafales ${gust} km/h)`;
        document.getElementById('weather-condition').textContent = condition;
        document.getElementById('weather-icon').src = `${CONFIG.iconBaseUrl}${iconCode}@2x.png`;

        const decision = this.analyzeRideCondition(temp, wind, gust, condition);
        const decisionElement = document.getElementById('weather-decision');
        decisionElement.textContent = decision.message;
        decisionElement.style.color = decision.color;
        decisionElement.style.background = decision.background;
      }

      findClosestForecast(targetDate, forecasts) {
        let closest = null;
        let minDiff = Infinity;

        for (const forecast of forecasts) {
          const forecastDate = new Date(forecast.dt * 1000);
          const diff = Math.abs(targetDate - forecastDate);
          if (diff < minDiff) {
            minDiff = diff;
            closest = forecast;
          }
        }
        return closest;
      }

      createChart(weatherData) {
        const ctx = document.getElementById('tempChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (this.chart) {
          this.chart.destroy();
        }

        const labels = [];
        const temps = [];
        const winds = [];

        weatherData.list.slice(0, 16).forEach(item => {
          const date = new Date(item.dt * 1000);
          labels.push(date.toLocaleDateString('fr-FR', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit' 
          }));
          temps.push(Math.round(item.main.temp));
          winds.push(Math.round(item.wind.speed * 3.6));
        });

        this.chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Temp√©rature (¬∞C)',
                data: temps,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4,
                yAxisID: 'y'
              },
              {
                label: 'Vent (km/h)',
                data: winds,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: false,
                tension: 0.4,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                position: 'top',
              }
            },
            scales: {
              x: {
                display: true,
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Temp√©rature (¬∞C)'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Vent (km/h)'
                },
                grid: {
                  drawOnChartArea: false,
                }
              }
            }
          }
        });
      }

      degToCardinal(deg) {
        const directions = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"];
        return directions[Math.round(deg / 45) % 8];
      }

      analyzeRideCondition(temp, wind, gust, condition) {
        let score = 0;
        
        // √âvaluation temp√©rature (optimal: 15-25¬∞C)
        if (temp >= 15 && temp <= 25) score += 3;
        else if (temp >= 10 && temp <= 30) score += 2;
        else if (temp >= 5 && temp <= 35) score += 1;

        // √âvaluation vent
        if (wind <= 15) score += 3;
        else if (wind <= 25) score += 2;
        else if (wind <= 35) score += 1;

        // √âvaluation rafales
        if (gust <= 25) score += 2;
        else if (gust <= 40) score += 1;

        // √âvaluation conditions
        const badWeather = ['pluie', 'orage', 'neige', 'gr√™le'];
        if (!badWeather.some(weather => condition.toLowerCase().includes(weather))) {
          score += 2;
        }

        // Retour de la d√©cision
        if (score >= 8) {
          return { 
            message: "Conditions id√©ales ! üö¥‚Äç‚ôÇÔ∏è‚ú®", 
            color: "white", 
            background: "var(--success-color)" 
          };
        } else if (score >= 6) {
          return { 
            message: "Conditions favorables ‚úÖ", 
            color: "white", 
            background: "var(--success-color)" 
          };
        } else if (score >= 4) {
          return { 
            message: "Conditions acceptables ‚ö†Ô∏è", 
            color: "white", 
            background: "var(--warning-color)" 
          };
        } else {
          return { 
            message: "Conditions difficiles ‚ùå", 
            color: "white", 
            background: "var(--danger-color)" 
          };
        }
      }

      showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-message').style.display = 'block';
      }
    }

    // Initialisation de l'application
    document.addEventListener('DOMContentLoaded', () => {
      new WeatherApp();
    });
  </script>
</body>
</html>
