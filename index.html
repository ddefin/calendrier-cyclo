<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Prochain Événement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background-color: #f9fbff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 2rem;
    }

    .event-card {
      max-width: 500px;
      margin: 2rem auto;
      padding: 1.5rem;
      border-radius: 12px;
      background: linear-gradient(135deg, #f0f4ff, #e0eaff);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      color: #333;
      animation: fadeIn 1s ease-in-out;
    }

    .event-card h2 {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      color: #2a4d9b;
    }

    #event-details p {
      margin: 0.5rem 0;
      font-size: 1.1rem;
    }

    #event-countdown {
      font-weight: bold;
      color: #d35400;
      animation: pulse 1.5s infinite;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }

  </style>
</head>
<body>

  <section class="event-card">
    <h2>📅 Prochain événement</h2>
    <div id="event-details">
      <p><strong>📝 Nom :</strong> <span id="event-title">Chargement...</span></p>
      <p><strong>🕒 Date :</strong> <span id="event-date">–</span></p>
      <p><strong>📍 Lieu :</strong> <span id="event-location">–</span></p>
      <p><strong>⏳ Dans :</strong> <span id="event-countdown">–</span></p>
    </div>
  </section>

  <script>
    fetch('https://ddefin.github.io/calendrier-cyclo/calendrier.ics') // ou URL directe si le fichier est en ligne
      .then(res => res.text())
      .then(text => {
        const events = text.split('BEGIN:VEVENT');
        let nextEvent = null;

        for (const evt of events) {
          const dtMatch = evt.match(/DTSTART(?:;TZID=Europe\/Paris)?:([0-9T]+)/);
          if (dtMatch) {
            const dt = dtMatch[1];
            const date = new Date(
              dt.slice(0,4),
              dt.slice(4,6)-1,
              dt.slice(6,8),
              dt.includes('T') ? dt.slice(9,11) : 0,
              dt.includes('T') ? dt.slice(11,13) : 0
            );
            if (date > new Date()) {
              nextEvent = { raw: evt, date };
              break;
            }
          }
        }

        if (nextEvent) {
          const titleMatch = nextEvent.raw.match(/SUMMARY:(.+)/);
          const locationMatch = nextEvent.raw.match(/LOCATION:(.+)/);
          const urlMatch = nextEvent.raw.match(/URL:(.+)/);

          const title = titleMatch ? titleMatch[1].trim() : "Événement";
          const location = locationMatch ? locationMatch[1].trim() : "Lieu non précisé";
          const url = urlMatch ? urlMatch[1].trim() : "#";

          document.getElementById('event-title').innerHTML = `<a href="${url}" target="_blank">${title}</a>`;
          document.getElementById('event-date').textContent = nextEvent.date.toLocaleString('fr-FR');
          document.getElementById('event-location').textContent = location;

          const now = new Date();
          const diff = nextEvent.date - now;
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
          const minutes = Math.floor((diff / (1000 * 60)) % 60);
          document.getElementById('event-countdown').textContent = `${days} j, ${hours} h, ${minutes} min`;
        } else {
          document.getElementById('event-title').textContent = "Aucun événement à venir";
        }
      });
  </script>
</body>
  <section class="event-card">
  <h2>🌤 Météo pour la sortie vélo</h2>
  <div id="velo-weather">
    <p><strong>📍 Ville :</strong> <span id="city">Serris</span></p>
    <p><strong>🌡 Température :</strong> <span id="temp">–</span>°C</p>
    <p><strong>🌬 Vent :</strong> <span id="wind">–</span></p>
    <p><strong>☁️ Ciel :</strong> <span id="condition">–</span></p>
    <p><strong>🚴 Sortie :</strong> <span id="velo-ok">Analyse...</span></p>
  </div>
</section>

<script>
  const apiKey = '0f9f95c50d2d777d38a9314a4ffadc93'; // remplace avec ta clé OpenWeather
  const city = 'Serris,FR';

  fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric&lang=fr`)
    .then(res => res.json())
    .then(data => {
      const temp = data.main.temp;
      const windSpeed = data.wind.speed * 3.6; // m/s → km/h
      const gust = data.wind.gust ? data.wind.gust * 3.6 : windSpeed;
      const windDeg = data.wind.deg;
      const condition = data.weather[0].description;

      // Convertir direction vent en texte
      const windDir = degToCardinal(windDeg);

      // Analyse de sortie "favorable"
      const sortieOk = analyzeRideCondition(temp, windSpeed, gust, condition);

      document.getElementById('temp').textContent = Math.round(temp);
      document.getElementById('wind').textContent = `${Math.round(windSpeed)} km/h ${windDir} (rafales ${Math.round(gust)} km/h)`;
      document.getElementById('condition').textContent = condition;
      document.getElementById('velo-ok').textContent = sortieOk.message;
      document.getElementById('velo-ok').style.color = sortieOk.color;
    })
    .catch(err => {
      console.error("Erreur météo :", err);
      document.getElementById('velo-ok').textContent = "Erreur météo";
    });

  function degToCardinal(deg) {
    const dirs = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"];
    return dirs[Math.round(deg / 45) % 8];
  }

  function analyzeRideCondition(temp, wind, gust, condition) {
    let note = 0;

    if (temp >= 10 && temp <= 28) note += 2;
    if (wind <= 20) note += 2;
    if (gust <= 30) note += 1;
    if (!condition.includes("pluie") && !condition.includes("orage")) note += 2;

    if (note >= 6) return { message: "Favorable ✅", color: "green" };
    if (note >= 4) return { message: "Acceptable ⚠️", color: "orange" };
    return { message: "Déconseillé ❌", color: "red" };
  }
</script>

</html>
